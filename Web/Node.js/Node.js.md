## Node.js

- 자바스크립트를 서버에서 구현하기 위한 런타임 환경
- **싱글 스레드로 동작하며 비동기식 입출력을 사용**한다.
     -> 싱글스레드 논블로킹 모델 : 비동기 I/O 작업을 통해 요청들은 서로 블로킹하지 않음
- 정확히 말하면 Node.js는 여러 개의 스레드를 가지기 때문에 싱글 스레드가 아니다. 하지만 자바스크립트를 실행하는 단 하나의 메인 스레드(이벤트 루프)를 통해 처리되기 때문에 싱글스레드라고 한다.

### 구성

![노드](https://user-images.githubusercontent.com/61968474/130497630-5e50dc3c-c17b-4528-aa00-c48a18303464.PNG)
- Node.js의 기본 구성 요소 : [리액터 패턴](https://github.com/ahnsoheee/TIL/blob/master/Design%20Pattern/Reactor.md) + libuv

1. libuv (c 라이브러리)
    - 논블로킹 엔진
    - 모든 주요 플랫폼과 호환되게 한다. (I/O 작업은 동일한 OS 내에서도 리소스 유형에 따라 다르게 동작한다.) 
    - 서로 다른 유형의 리소스들의 논블로킹 동작을 표준화한다.
    - 기본 시스템 호출을 추상화한다.
    - 이벤트 루프 제공, 이벤트 큐 관리, 비동기 입출력 작업을 실행한다.
    - 리버브의 스레드 풀은 멀티 스레드 방식, JS를 실행하는 메인 스레드(이벤트 루프)는 단 하나이기 때문에 Node.js를 싱글 스레드라고 한다.

2. V8
    - 원래 구글 크롬 브라우저 용으로 개발한 JavaScript 엔진 (Node.js가 빠르고 효율적인 이유; 속도가 빠르고 효율적인 메모리 관리!!)
    - 메모리 힙과 콜 스택으로 구성
    - 자바스크립트 엔진은 콜스택에 쌓인 실행 컨텍스트에 따라 위에서부터 차례로 실행되기 때문에 비동기 처리를 할 수 없다. 따라서 비동기 처리가 필요한 경우 libuv 라이브러리에서 제공하는 비동기 처리를 하게 된다.

3. 바인딩 세트
    - libuv와 낮은 수준의 기능들을 JavaScript에 랩핑하고 사용가능하도록 해준다.

4. 코어 JavaScript 라이브러리 (노드 코어)
    - 상위 수준의 Node.js API를 구현하고 있다.


### 동작 과정

![node](https://user-images.githubusercontent.com/61968474/130496872-2921718e-bac1-4a2c-a5f2-a9069d4f5685.PNG)

- 입력이 발생하면 스레드 풀에 작업을 전달하고, 입출력이 완료되면 이벤트 큐에 콜백 함수를 쌓는다.
- 이벤트 루프(**메인 스레드**)는 항상 돌고 있다가 V8 엔진의 호출 스택이 비워지면 이벤트 큐에서 작업을 처리한다.
- 작업이 완료될 때까지 기다리지 않고 다른 작업을 먼저 처리하는 non-blocking 방식으로 처리한다.
- 노드는 이벤트 기반으로 이벤트 리스너에 등록해 둔 콜백함수를 실행하는 방식으로 동작한다. 여기서 콜백함수를 관리하는 것이 이벤트 루프이고, 이벤트 루프는 이벤트 발생 시 호출되는 콜백함수를 태스크 큐에 전달한다.
- 태스크 큐에 담긴 콜백함수를 콜스택에 넘겨준다.
    - 태스크 큐(매크로 태스크 큐 / 콜백 큐) : Web API에서 비동기 작업이 실행된 후 호출되는 콜백함수들이 기다리는 공간
    - 태스크 큐에는 마이크로태스크 큐, 애니메이션 프레임 등 여러가지 큐로 구성
    - 매크로 태스크 큐: setTimeout, setInterval, setImmediate
    - 마이크로 태스크 큐: Promise.then
    - 우선순위 : 마이크로 태스크 > 애니메이션 프레임 > 매크로 태스크
- 싱글 스레드 기반이기 때문에 PM2를 활용해 멀티 스레드처럼 사용할 수 있다.

### JS 비동기 처리 과정

<img width="762" alt="스크린샷 2022-02-13 오후 2 04 48" src="https://user-images.githubusercontent.com/61968474/153739520-275fd7c3-56a8-4835-a74b-62b89c951bc9.png">

- 호출 스택에 쌓인 후 자바스크립트 엔진은 비동기 작업을 Web API에게 위임한다.
- Web API는 해당 작업을 수행하고, 이벤트 루프를 통해 콜백함수를 태스크 큐에 전달한다.
- 이벤트 루프는 콜스택이 비워지면, 태스크 큐에서 대기하던 콜백함수를 콜스택으로 넘긴다.
- 콜스택에 쌓인 함수가 실행되고, 콜스택에서 제거된다.
- 이러한 방식으로 비동기 처리가 진행된다.

### NPM
- Node 모듈을 관리해주는 패키지 매니저

<details>
<summary>참고</summary>

- [왜 node.js는 single-thread 인가](https://medium.com/@gwakhyoeun/%EC%99%9C-node-js%EB%8A%94-single-thread-%EC%9D%B8%EA%B0%80-bb68434027a3)
- https://medium.com/@vdongbin/javascript-%EC%9E%91%EB%8F%99%EC%9B%90%EB%A6%AC-single-thread-event-loop-asynchronous-e47e07b24d1c
</details>